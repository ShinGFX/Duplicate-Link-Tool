# パッチノート

## v2.0.0 (2025-12-07)

### 重要な変更

#### ジャンクション機能の削除
- **ジャンクションのリンク作成機能を削除**: 本ソフトウェアの主な用途（ファイル単位の重複検出とリンク化）と相性が悪いため、ジャンクション作成機能を完全に削除しました
  - UIから「ジャンクション (フォルダのみ)」選択肢を削除
  - `create_link()`関数からジャンクション作成ロジックを削除
  - **既存ディレクトリ内のジャンクション検出機能は保持**（リンク状況表示で既存ジャンクションを確認可能）

### バグ修正

#### 重複検出の改善
- **リンクファイルの除外**: 重複検出時にショートカット(.lnk)、シンボリックリンク、ハードリンク、ジャンクションを検出対象から除外
  - リンク作成後に再検出を実行しても、作成したリンクが誤って重複として検出されなくなりました

#### データ消失防止
- **双方向リンク防止機能**: 両方のファイルがすでにリンクの場合、リンク化をスキップして実体消失を防止
  - 双方がリンクの場合は `[FAIL]` ログを出力し、処理をスキップ
  - 片方がリンクの場合は `[WARN]` を出力しつつ処理を継続

### UI/UX改善

#### カラーコーディングによる視認性向上
- **ディレクトリ入力欄と関連ボタンの色分け**: ダークモードに調和した色付き●でディレクトリと機能の関連性を明確化
  - **● αディレクトリ（青緑: #5dade2）**: ラベルの●のみに色を適用
    - 関連ボタン: 「●● 重複を検出」（α+β両方）、「● 非重複(α)を開く」
  - **● βディレクトリ（オレンジ: #e59866）**: ラベルの●のみに色を適用
    - 関連ボタン: 「●● 重複を検出」（α+β両方）、「● 非重複(β)を開く」
  - **● 実体化用ディレクトリ（紫: #bb8fce）**: ラベルの●のみに色を適用
    - 関連ボタン: 「● リンクを実体化」「● 実体化して圧縮」
  - 番号表記（1)、2)、3)）を廃止し、色付き●で視覚的に関連性を表現

#### ボタンの視覚的フィードバック
- **クリック時のフィードバック**: ボタンクリック時に押下状態が視覚的に表示されるように改善
- **Frameベースのカスタムボタン**: 色付き●とテキストを組み合わせた新しいボタンデザイン

#### 高解像度アイコン対応
- **タイトルバー・タスクバーのアイコン高解像度化**: Windows APIを使用して高解像度アイコンを設定
  - ウィンドウ表示完了後にアイコンを適用することで確実に反映

#### ログメッセージの最適化
- **リンクタイプ別のログ表示**: リンク種別に応じて適切なログメッセージを表示
  - **ショートカット/シンボリックリンク**: パス形式（相対/絶対）と残した側（α/β）を表示
  - **ハードリンク**: シンプルな双方向表記（ファイル名や残す側は無関係）

#### 設定の動的無効化
- **リンク方式に応じた設定の無効化**: 選択中のリンク種別に関係ない設定を自動的に無効化
  - **ハードリンク選択時**: 以下の設定が無効化（グレーアウト）
    - 「リンクパスの形式（相対/絶対）」
    - 「リンク作成後に残すファイル名（α側/β側）」
    - 「リンク化実行時にどちらを残すか（α/β）」
  - **ショートカット選択時**: 以下の設定が無効化（グレーアウト）
    - 「リンクパスの形式（相対/絶対）」（ショートカットは内部的に常に絶対パスを保存するため）

### 既知の制限事項（Windowsの仕様）

以下はWindowsのファイルシステム仕様による制限です。

#### リンク形式ごとの制限
- **シンボリックリンク**: ドライブをまたいだ移動/コピーで処理が進まなくなります（相対パス・絶対パス共通）。ドライブ間で移動する可能性がある場合は「ショートカット」を使用してください
- **シンボリックリンク**: ファイル構造の変更（リンクまたは実体の移動）でリンク切れになります（同一ドライブ内でも）
- **シンボリックリンク**: ネットワークドライブには作成できません（ローカルドライブのみ）
- **ハードリンク**: ドライブ間で移動するとリンクが解除され、各ファイルが独立した実体になります（容量削減効果が失われます）
- **ハードリンク**: 異なるドライブ/パーティション間では作成できません（同一ボリューム内のみ）
- **ハードリンク**: フォルダには作成できません（ファイルのみ）

#### ファイルシステムの制限
- **NTFS必須**: シンボリックリンク・ハードリンクはNTFSでのみ動作します（FAT32/exFATでは使用不可）
- **パス長制限**: Windowsのデフォルトは260文字まで

#### 運用上の注意
- **OneDrive/クラウド同期**: シンボリックリンク・ハードリンクは正常に同期されない可能性があります
- **バックアップソフト**: リンクの扱いはソフトによって異なります
- **ZIP圧縮**: リンクは通常、実体としてアーカイブされます（リンク関係は失われます）

#### 実体化機能の操作性改善
- **実体化用ディレクトリの事前選択方式に統一**: 「リンクを実体化」と「実体化して圧縮」の両機能で、同一の入力欄を使用
  - 事前に入力欄でディレクトリを選択してからボタンを押す統一的なワークフロー

#### 非重複ファイル表示の改善
- **クラッシュ防止**: 非重複ファイル数が多い場合でも安全に処理
  - バックグラウンドスレッドで順次処理（ファイル間に0.5秒の間隔）
  - **キャンセルボタンでいつでも中断可能**

### コードリファクタリング

#### アーキテクチャの改善
- **Appクラスの構造化**: 初期化処理をメソッドに分割し、コードの可読性を向上
  - `_init_variables()`: 変数の初期化
  - `_setup_window()`: ウィンドウの設定
  - `_setup_styles()`: スタイルの設定
  - `_create_widgets()`: ウィジェットの作成
  - `_bind_events()`: イベントのバインド
- **ウィジェット作成の共通化**: `_create_dir_row()`, `_create_custom_btn()`などのヘルパーメソッドを追加

#### ウィンドウ表示の改善
- **起動時の灰色ライン除去**: ウィンドウ初期化完了まで非表示にし、描画完了後に表示することで起動直後の不要な境界線を削除
  - `withdraw()`/`deiconify()`による初期化中の非表示化

---

## v1.1.0 (2025-11-20)

### 新機能

#### パス入力の強化
- **履歴機能**: 上下矢印キーでセッション中に入力したパスを再利用（最大50件保存）
- **Undo/Redo機能**: Ctrl+Z（元に戻す）、Ctrl+Y（やり直し）に対応
- **「αと同じ」チェックボックス**: βディレクトリに同じパスを自動入力し、同一フォルダ内での重複検出を簡単に実行
  - チェック時はβ入力欄が灰色で無効化

#### 検出結果の選択機能
- 検出結果リストに個別チェックボックスを追加
  - 個別クリックで選択/解除
  - Shift+クリックで範囲選択/範囲解除
  - ヘッダークリックで全選択/全解除
- 選択したアイテムのみをリンク化可能（選択なしの場合は警告表示）

#### リンク作成の柔軟性向上
- **相対パス/絶対パスの選択**: シンボリックリンクとショートカット作成時にパス形式を選択可能
  - 相対パスは自動計算され、異なるドライブ間では自動的に絶対パスにフォールバック
  - ログに作成形式を明記（例：「相対パス」「絶対パス」）
- **どちらを残すかの選択**: リンク化実行時に実体として残すディレクトリを選択可能
  - 「αを残す（β側をリンク化）」または「βを残す（α側をリンク化）」
  - 処理ロジックが動的に切り替わり、選択に応じた変換を実行

### UI/UX改善

#### 表記の統一と明確化
- ディレクトリ名称を「メイン」「比較」から「**α**」「**β**」に統一
- 検出結果ヘッダーに実際のフォルダ名を表示（「α」「β」の代わり）
- 判定結果列を「Reason」から「**判定内容**」に変更
- CSVヘッダーを「Main, Duplicate, Reason」から「**α, β, 判定内容**」に変更
- ディレクトリラベルから「(基準側)」「(比較側)」の括弧表記を削除

#### リンク情報表示の改善
- シンボリックリンク、ジャンクション、ハードリンク、ショートカットを個別に表示
- 表示順序をUI選択順に統一：**ショートカット → シンボリックリンク → ハードリンク → ジャンクション**
- 例：`リンク状況: ショートカット 3件, シンボリックリンク 2件, ハードリンク 4件, ジャンクション 1件`

#### レイアウトと操作性
- カラムヘッダークリック時の誤動作を修正（下のアイテムが選択されない）
- リンクパス形式選択をリンク種別の直下に配置
- 選択ボタンの順序を直感的に変更（相対パス → 絶対パス）

#### デフォルト設定の最適化
- リンク種別：シンボリックリンク → **ショートカット**
- パス形式：絶対パス → **相対パス**
- 残すファイル名：β側 → **α側**
- よりポータブルで安全な初期設定に変更

### パフォーマンスと品質

#### 同一フォルダ比較の最適化
- 同一ファイルパス同士の無意味な比較を除外（A.txt ⇔ A.txt）
- 重複ペアの逆順検出を防止（A ⇔ B を検出した場合、B ⇔ A は検出しない）
- 非重複数の計算ロジックを改善し、正確な統計を表示

#### セキュリティ強化
- `mklink`コマンド実行時に`shell=False`を使用（OSコマンドインジェクション対策）
- コマンドを文字列からリスト形式に変更し、安全性を向上

#### 文字エンコーディング
- ショートカット作成時にUTF-8 BOM付きエンコーディングを使用
- 絵文字や日本語を含むファイル名の文字化けを解消

#### コード品質
- デバッグ用ログを削除し、クリーンアップ
- 冗長な関数を削除・簡略化
- 未使用パラメータを削除
- 不要なファイルとディレクトリを整理

### 技術的変更

#### アーキテクチャ
- `HistoryEntry`クラスを新規作成（履歴・Undo/Redo機能を実装）
- Treeviewを3列から4列に拡張（選択列を追加）
- 選択状態管理機能を実装（`tree_selection_state`辞書）

#### リンク処理
- `create_link`関数に`use_relative_path`パラメータを追加
- `keep_side`パラメータによる動的な処理切り替えを実装
- ショートカット作成時に`WorkingDirectory`プロパティを正しく設定
- リンク検出ロジックを改善（シンボリックリンク/ジャンクション/ハードリンクを正確に区別）

#### その他
- PowerShellスクリプト実行時のエンコーディングをUTF-8 BOMに統一
- アイコンファイル名を`duplicate_link_tool.ico`に統一
- ウィンドウ初期化時の`update_idletasks()`を複数回実行してレイアウトを安定化

---

## v1.0.0 (初回リリース)

基本的な重複ファイル検出とリンク化機能を提供
- 2つのディレクトリ間での重複ファイル検出
- シンボリックリンク、ハードリンク、ジャンクション、ショートカットの作成
- リンクの実体化機能
- 実体化して圧縮機能
- ダークテーマUI


### 新機能
- **パス入力欄の履歴機能**: 上下矢印キーで起動セッション中に入力したパスを再利用できるようになりました（最大50件）
- **Undo/Redo機能**: パス入力欄でCtrl+Z（元に戻す）とCtrl+Y（やり直し）が使えるようになりました
- **αと同じパス自動入力**: βディレクトリの横に「αと同じ」チェックボックスを追加。チェックするとαディレクトリと同じパスが自動入力され、同一フォルダ内での重複検出が簡単になりました
  - チェック時はβディレクトリ入力欄が灰色表示で無効化されます
- **検出結果の選択機能**: 検出結果リストの左側にチェックボックスを追加
  - クリックで個別選択/解除
  - Shift+クリックで範囲選択/範囲解除
  - ヘッダーのチェックボックスで全選択/全解除
  - 選択したアイテムのみに対してリンク化操作を実行可能（選択なしの場合は警告を表示）
- **相対パス/絶対パスの選択機能**: シンボリックリンクとショートカット作成時に、ターゲットパスを相対パスまたは絶対パスで指定できるようになりました
  - **デフォルトは相対パス**（v1.1.0で変更）
  - 相対パスを選択すると、リンク元からターゲットへの相対パスが自動計算されます
  - 異なるドライブ間など相対パス化できない場合は自動的に絶対パスで作成されます
  - ハードリンクとジャンクションには適用されません（これらは常に絶対パスで動作します）
  - ログに「相対パス」または「絶対パス」の表示を追加し、どちらで作成されたか一目で確認可能
- **どちらを残すかの選択機能**: リンク化実行時にどちらのディレクトリを実体として残すかを選択できるようになりました
  - 「αを残す（β側をリンク化）」：α側を実体として残し、β側をリンクに変換
  - 「βを残す（α側をリンク化）」：β側を実体として残し、α側をリンクに変換
  - デフォルトは「αを残す」
  - リンク化処理のロジックが動的に切り替わり、選択に応じた処理を実行

### 改善
- **UI表記の改善**:
  - ディレクトリ名称を「メイン」「比較」から「α」「β」に変更し、混乱を防止
  - 「実体化して圧縮するディレクトリ」の番号を削除（1), 2)と連続的な関係ではないため）
  - 比較結果ヘッダーを「Main」「Duplicate」から「α」「β」に変更
  - 判定結果列のヘッダーを「Reason」から「判定内容」に変更
  - リンク作成後に残すファイル名の選択順序を変更：α側を左に配置しデフォルトに設定
  - CSVエクスポートのヘッダーを「Main, Duplicate, Reason」から「α, β, 判定内容」に変更
  - ディレクトリラベルから「(基準側)」「(比較側)」の括弧付き説明を削除
  - 検出結果リストのヘッダーに各ディレクトリのフォルダ名を表示（「α」「β」の代わりに実際のフォルダ名を表示）
