# パッチノート

## v2.2.0 (2026-02-20)

### 新機能

#### 高DPI ディスプレイ対応（System DPI Aware）
- **ネイティブ解像度でのUI描画**: 高解像度ディスプレイ（4K等）でテキストやUIがぼやける問題を解決
  - `SetProcessDpiAwareness(1)` による System DPI Aware の有効化（Windows 8.1以降）
  - `_dp()` ヘルパー関数により、ウィンドウサイズ・最小サイズ、パディング、カラム幅、行高さなど全ピクセル値をDPIスケール倍率に応じて動的変換
  - Treeview の `rowheight` にもDPIスケーリングを適用（tkinterデフォルトでは自動スケーリングされないため）
  - EXE用アプリケーションマニフェスト (`dlt_manifest.xml`) に `<dpiAware>true</dpiAware>` を宣言

#### リンク化チェーン衝突の自動解決
- **チェーンリダイレクト機能**: A=B=C の重複で B→link(A), C→link(B) を同時実行する場合、C のターゲットを自動的に最終実体 A にリダイレクト
  - `_build_chain_redirect_map()` で「削除されるファイル→ターゲット」マップを事前構築し、`_resolve_chain_target()` でチェーンを辿って最終実体を解決（循環検出付き）
  - ショートカット・シンボリックリンク・ハードリンクの全リンク方式に適用
  - リダイレクト発生時はログに `[INFO] チェーン解決` と表示

#### Treeview / ログ間のドラッグリサイズ
- **ドラッグ可能なサッシュ（分割バー）**: Treeview とログ領域の間にドラッグハンドルを追加し、各領域のサイズをマウス操作で調整可能に
  - Treeview最小高さ・ログ最小高さの制約を設け、どちらかが完全に隠れることを防止
  - 16msスロットリングにより滑らかなリサイズ描画を実現

#### ウィンドウリサイズ追従
- **ウィンドウ縮小・拡大に応じてログ領域の高さを自動調整**: Treeview/ログ以外の固定領域の高さを実測し、残りの領域をTreeviewとログに適切に配分
  - ウィンドウ最小サイズを固定領域 + Treeview最小高さ + ログ最小高さから動的に計算
  - ログ先行でpackすることでpack配分の優先権を確保し、ウィンドウ縮小時にログが消えるのを防止

### バグ修正

#### 同一ファイル検出の強化
- **`os.path.samefile()` による物理ファイル比較を追加**: パス文字列の正規化だけでは一致しないケース（ジャンクション、substドライブ、マウントポイント経由）でも同一ファイルを確実に除外
  - name+size候補ループ、size+hash候補ループ、dedup後処理の3箇所に適用

#### 非ANSI文字を含むパスのショートカット作成対応
- **cp932範囲外の文字（絵文字等）を含むパスのショートカット作成に対応**: WScript.Shell COM は ANSI API を使用するため、cp932で表現できない文字がパスに含まれると `ArgumentException` が発生する問題を修正
  - `_is_ansi_safe()` でパスの全文字がcp932で表現可能か判定
  - リンクパスにcp932外の文字がある場合は一時ファイル方式を自動適用
  - ターゲットパス/WorkingDirectory にcp932外の文字がある場合は `_get_short_path()` で8.3短縮パスに変換

#### リンク作成時のデータ消失リスクの排除
- **元ファイルの削除タイミングを安全な順序に変更**: シンボリックリンク・ハードリンク作成時、リンク作成が成功した後にのみ元ファイルを削除するように変更
  - `_remove_existing_path()` メソッドで削除処理を統一（シンボリックリンク/ディレクトリ/通常ファイルを適切に処理）

#### ウィンドウ前面表示の安定化
- `_ensure_front()` で不要な `deiconify()` による二重描画を修正

### UI/UX改善

#### ● ラベルのレイアウト修正
- **ディレクトリ行の色付き●ラベルが見切れる問題を修正**: `tk.Frame` + `pack(side='left')` による正確なレイアウトに変更し、高DPI環境でも正しく表示

#### アクションボタン状態の一元管理
- **`_set_action_buttons()` メソッドによるボタン状態の統一管理**: リンク化ボタン、検出ボタン、実体化ボタン、ZIP化ボタン、非重複ボタンの有効/無効状態を一括管理

#### リンク化ログのパス形式表示修正
- **シンボリックリンク作成時のログに正確なパス形式を表示**: シンボリックリンクのみ「相対パス」/「絶対パス」を表示するように修正（ショートカットは内部的に常に絶対パスのため表示対象外）

### コードリファクタリング

#### 型アノテーションの現代化（PEP 604）
- **`typing` モジュールへの依存を完全に除去**: `Optional[X]` → `X | None`、`List` / `Tuple` / `Set` → ビルトイン型（`list` / `tuple` / `set`）に全面移行
  - `duplicate_link_tool_windows.py`: 約10箇所の関数シグネチャ・変数型を更新
  - `zip_util.py`: `resolve_shortcut()`, `_build_realization_plan()`, `realize_directory()` 等の全関数を更新

#### `normalize()` のモジュールレベル関数化
- **パス正規化関数を独立化**: `find_duplicates()` 内のネスト関数をモジュールレベル関数に抽出し、チェーンリダイレクト等の他機能からも再利用可能に

#### 未使用コードの整理
- 未使用変数（`LR_DEFAULTSIZE`、未参照のインスタンス変数）、冗長なインポート（`import traceback` 重複、`import os` in spec）、不要な関数パラメータ・戻り値を削除

#### 管理者権限チェックの簡素化
- 無意味な `pass` 分岐を除去し、条件分岐を整理

### ビルド・パッケージング

#### アプリケーションマニフェストの導入
- **外部マニフェスト `dlt_manifest.xml` を新規追加**: 管理者権限要求（`requireAdministrator`）とDPI Aware宣言を統合
  - Common Controls v6.0 依存関係の宣言によるモダンUI外観の適用
  - PyInstaller の `manifest=` パラメータで指定（`uac_admin` フラグに代えて使用）

## v2.1.0 (2026-02-16)

### 新機能

#### サイズ列の追加
- **重複一覧にサイズ列を追加**: 判定内容の右側にファイルサイズ列を表示
  - リンク化で削減されるサイズ（α側）を `n.nn GB` / `n.nn MB` / `n.nn KB` 形式で表示
  - CSV出力にもサイズ情報を含むように対応

#### ヘッダークリックによるソート機能
- **サイズ列ヘッダー**: タップするたびにサイズの降順⇔昇順を切替（▼/▲インジケーター付き）
- **判定内容列ヘッダー**: タップするたびに判定理由別にソート切替（▼/▲インジケーター付き）
- **α/βフォルダ名ヘッダー**: タップでフォルダ名ごとにグループ化ソート（モード切替なし）

#### 選択情報の表示
- **選択中アイテムの集計表示**: チェックボックスで選択した項目数と合計サイズをリアルタイム表示
  - 「選択中: N 件 / 合計サイズ: n.nn GB」形式で黄色テキストにて表示
  - 単一クリック・Shift範囲選択・全選択/全解除のすべてに対応

### バグ修正

#### PowerShell 実行ファイルの検出改善
- **PowerShell パス検出の堅牢化**: ショートカット作成時の `powershell_not_found` エラーを修正
  - `_find_powershell()` 関数を追加し、以下の順序でPowerShellを検索：
    1. PATH環境変数から `powershell.exe` を検索
    2. 標準的なWindowsパス（System32、SysWOW64）を確認
    3. PowerShell Core (`pwsh.exe`) を検索
  - PATH環境変数が不適切に設定されている環境でもショートカット作成が可能に

#### 重複合計サイズの整合性修正
- **サイズ表示の統一**: 重複合計サイズ・各行のサイズ・選択時の合計サイズをすべてα側（＝リンク化で削減される分）に統一

#### 検出リセット時のヘッダー状態修正
- **全選択ヘッダーのリセット**: 再検出時にselect列ヘッダーが`☑`のまま残る不具合を修正

#### リンク化成功アイテムの自動除去
- **リンク化後に成功アイテムを自動的にリストから削除**: リンク化処理成功後、再検出なしで結果一覧を即座に更新
  - 重複検出数・重複合計サイズ・選択情報もリアルタイムで再計算

#### 同一パス重複検出バグの修正
- **ディレクトリが重複・包含関係にある場合の同一ファイルパスペアの除外**: αとβのディレクトリが親子関係にある場合でも、同一ファイルが自分自身と重複検出されないように修正
  - 同一パス除外チェックを`is_same_folder`条件から独立させ、常に実行
  - 事後dedup処理で逆順ペアと同一パスペアを常に除去
  - ディレクトリ重複時にログメッセージで通知

#### PowerShell サブプロセス出力のエンコーディング修正
- **cp932エンコーディングへの変更**: PowerShellサブプロセスの出力エンコーディングを`utf-8`から`cp932`（日本語Windows標準）に変更
  - 日本語パスを含むショートカット作成時に`UnicodeDecodeError`が発生する問題を修正
  - `errors='replace'`オプションによりデコード不能文字を安全に置換

#### サブプロセス出力のNone安全性修正
- **stderr/stdout の Noneチェック追加**: PowerShellサブプロセスの`result.stderr`が`None`を返す場合に`AttributeError`が発生する問題を修正
  - `(result.stderr or '').strip()` パターンでNone安全な文字列処理を実装

#### リンク化処理の例外安全性改善
- **_linking_workerのtry/except包括**: リンク化ワーカースレッドで予期しない例外が発生した場合でも、UIの状態（ボタン有効化・ステータス表示）が確実に復元されるように改善
  - 例外発生時も`_post_linking_ui_updates`が呼び出され、ボタンが押下状態のまま固まる不具合を防止

#### 長いパスのショートカット作成対応
- **ANSIバイト数によるMAX_PATHチェック**: `WScript.Shell.CreateShortcut()`がANSI（cp932）バイト数でパス長を判定する仕様に対応
  - 日本語文字（例: "サンプル"）は1文字2バイトとしてカウントされるため、Unicode文字数では260文字以内でもANSIバイト数で超過するケースに対応
  - `_ansi_path_len()`関数でcp932エンコード後のバイト長を計算
  - `_get_short_path()`関数でWin32 API経由の8.3形式短縮パスを取得
  - ANSIバイト数が上限を超える場合、一時ディレクトリ（`%TEMP%`）にショートカットを作成後、`[System.IO.File]::Move`で`\\?\`プレフィックス付きの長いパスへ移動する方式で確実に作成

## v2.0.0 (2025-12-07)

### 重要な変更

#### ジャンクション機能の削除
- **ジャンクションのリンク作成機能を削除**: 本ソフトウェアの主な用途（ファイル単位の重複検出とリンク化）と相性が悪いため、ジャンクション作成機能を完全に削除しました
  - UIから「ジャンクション (フォルダのみ)」選択肢を削除
  - `create_link()`関数からジャンクション作成ロジックを削除
  - **既存ディレクトリ内のジャンクション検出機能は保持**（リンク状況表示で既存ジャンクションを確認可能）

### バグ修正

#### 重複検出の改善
- **リンクファイルの除外**: 重複検出時にショートカット(.lnk)、シンボリックリンク、ハードリンク、ジャンクションを検出対象から除外
  - リンク作成後に再検出を実行しても、作成したリンクが誤って重複として検出されなくなりました

#### データ消失防止
- **双方向リンク防止機能**: 両方のファイルがすでにリンクの場合、リンク化をスキップして実体消失を防止
  - 双方がリンクの場合は `[FAIL]` ログを出力し、処理をスキップ
  - 片方がリンクの場合は `[WARN]` を出力しつつ処理を継続

### UI/UX改善

#### カラーコーディングによる視認性向上
- **ディレクトリ入力欄と関連ボタンの色分け**: ダークモードに調和した色付き●でディレクトリと機能の関連性を明確化
  - **● αディレクトリ（青緑: #5dade2）**: ラベルの●のみに色を適用
    - 関連ボタン: 「●● 重複を検出」（α+β両方）、「● 非重複(α)を開く」
  - **● βディレクトリ（オレンジ: #e59866）**: ラベルの●のみに色を適用
    - 関連ボタン: 「●● 重複を検出」（α+β両方）、「● 非重複(β)を開く」
  - **● 実体化用ディレクトリ（紫: #bb8fce）**: ラベルの●のみに色を適用
    - 関連ボタン: 「● リンクを実体化」「● 実体化して圧縮」
  - 番号表記（1)、2)、3)）を廃止し、色付き●で視覚的に関連性を表現

#### ボタンの視覚的フィードバック
- **クリック時のフィードバック**: ボタンクリック時に押下状態が視覚的に表示されるように改善
- **Frameベースのカスタムボタン**: 色付き●とテキストを組み合わせた新しいボタンデザイン

#### 高解像度アイコン対応
- **タイトルバー・タスクバーのアイコン高解像度化**: Windows APIを使用して高解像度アイコンを設定
  - ウィンドウ表示完了後にアイコンを適用することで確実に反映

#### ログメッセージの最適化
- **リンクタイプ別のログ表示**: リンク種別に応じて適切なログメッセージを表示
  - **ショートカット/シンボリックリンク**: パス形式（相対/絶対）と残した側（α/β）を表示
  - **ハードリンク**: シンプルな双方向表記（ファイル名や残す側は無関係）

#### 設定の動的無効化
- **リンク方式に応じた設定の無効化**: 選択中のリンク種別に関係ない設定を自動的に無効化
  - **ハードリンク選択時**: 以下の設定が無効化（グレーアウト）
    - 「リンクパスの形式（相対/絶対）」
    - 「リンク作成後に残すファイル名（α側/β側）」
    - 「リンク化実行時にどちらを残すか（α/β）」
  - **ショートカット選択時**: 以下の設定が無効化（グレーアウト）
    - 「リンクパスの形式（相対/絶対）」（ショートカットは内部的に常に絶対パスを保存するため）

### 既知の制限事項（Windowsの仕様）

以下はWindowsのファイルシステム仕様による制限です。

#### リンク形式ごとの制限
- **シンボリックリンク**: ドライブをまたいだ移動/コピーで処理が進まなくなります（相対パス・絶対パス共通）。ドライブ間で移動する可能性がある場合は「ショートカット」を使用してください
- **シンボリックリンク**: ファイル構造の変更（リンクまたは実体の移動）でリンク切れになります（同一ドライブ内でも）
- **シンボリックリンク**: ネットワークドライブには作成できません（ローカルドライブのみ）
- **ハードリンク**: ドライブ間で移動するとリンクが解除され、各ファイルが独立した実体になります（容量削減効果が失われます）
- **ハードリンク**: 異なるドライブ/パーティション間では作成できません（同一ボリューム内のみ）
- **ハードリンク**: フォルダには作成できません（ファイルのみ）

#### ファイルシステムの制限
- **NTFS必須**: シンボリックリンク・ハードリンクはNTFSでのみ動作します（FAT32/exFATでは使用不可）
- **パス長制限**: Windowsのデフォルトは260文字まで

#### 運用上の注意
- **OneDrive/クラウド同期**: シンボリックリンク・ハードリンクは正常に同期されない可能性があります
- **バックアップソフト**: リンクの扱いはソフトによって異なります
- **ZIP圧縮**: リンクは通常、実体としてアーカイブされます（リンク関係は失われます）

#### 実体化機能の操作性改善
- **実体化用ディレクトリの事前選択方式に統一**: 「リンクを実体化」と「実体化して圧縮」の両機能で、同一の入力欄を使用
  - 事前に入力欄でディレクトリを選択してからボタンを押す統一的なワークフロー

#### 非重複ファイル表示の改善
- **クラッシュ防止**: 非重複ファイル数が多い場合でも安全に処理
  - バックグラウンドスレッドで順次処理（ファイル間に0.5秒の間隔）
  - **キャンセルボタンでいつでも中断可能**

### コードリファクタリング

#### アーキテクチャの改善
- **Appクラスの構造化**: 初期化処理をメソッドに分割し、コードの可読性を向上
  - `_init_variables()`: 変数の初期化
  - `_setup_window()`: ウィンドウの設定
  - `_setup_styles()`: スタイルの設定
  - `_create_widgets()`: ウィジェットの作成
  - `_bind_events()`: イベントのバインド
- **ウィジェット作成の共通化**: `_create_dir_row()`, `_create_custom_btn()`などのヘルパーメソッドを追加

#### ウィンドウ表示の改善
- **起動時の灰色ライン除去**: ウィンドウ初期化完了まで非表示にし、描画完了後に表示することで起動直後の不要な境界線を削除
  - `withdraw()`/`deiconify()`による初期化中の非表示化

---

## v1.1.0 (2025-11-21)

### 新機能

#### パス入力の強化
- **履歴機能**: 上下矢印キーでセッション中に入力したパスを再利用（最大50件保存）
- **Undo/Redo機能**: Ctrl+Z（元に戻す）、Ctrl+Y（やり直し）に対応
- **「αと同じ」チェックボックス**: βディレクトリに同じパスを自動入力し、同一フォルダ内での重複検出を簡単に実行
  - チェック時はβ入力欄が灰色で無効化

#### 検出結果の選択機能
- 検出結果リストに個別チェックボックスを追加
  - 個別クリックで選択/解除
  - Shift+クリックで範囲選択/範囲解除
  - ヘッダークリックで全選択/全解除
- 選択したアイテムのみをリンク化可能（選択なしの場合は警告表示）

#### リンク作成の柔軟性向上
- **相対パス/絶対パスの選択**: シンボリックリンクとショートカット作成時にパス形式を選択可能
  - 相対パスは自動計算され、異なるドライブ間では自動的に絶対パスにフォールバック
  - ログに作成形式を明記（例：「相対パス」「絶対パス」）
- **どちらを残すかの選択**: リンク化実行時に実体として残すディレクトリを選択可能
  - 「αを残す（β側をリンク化）」または「βを残す（α側をリンク化）」
  - 処理ロジックが動的に切り替わり、選択に応じた変換を実行

### UI/UX改善

#### 表記の統一と明確化
- ディレクトリ名称を「メイン」「比較」から「**α**」「**β**」に統一
- 検出結果ヘッダーに実際のフォルダ名を表示（「α」「β」の代わり）
- 判定結果列を「Reason」から「**判定内容**」に変更
- CSVヘッダーを「Main, Duplicate, Reason」から「**α, β, 判定内容**」に変更
- ディレクトリラベルから「(基準側)」「(比較側)」の括弧表記を削除

#### リンク情報表示の改善
- シンボリックリンク、ジャンクション、ハードリンク、ショートカットを個別に表示
- 表示順序をUI選択順に統一：**ショートカット → シンボリックリンク → ハードリンク → ジャンクション**
- 例：`リンク状況: ショートカット 3件, シンボリックリンク 2件, ハードリンク 4件, ジャンクション 1件`

#### レイアウトと操作性
- カラムヘッダークリック時の誤動作を修正（下のアイテムが選択されない）
- リンクパス形式選択をリンク種別の直下に配置
- 選択ボタンの順序を直感的に変更（相対パス → 絶対パス）

#### デフォルト設定の最適化
- リンク種別：シンボリックリンク → **ショートカット**
- パス形式：絶対パス → **相対パス**
- 残すファイル名：β側 → **α側**
- よりポータブルで安全な初期設定に変更

### パフォーマンスと品質

#### 同一フォルダ比較の最適化
- 同一ファイルパス同士の無意味な比較を除外（A.txt ⇔ A.txt）
- 重複ペアの逆順検出を防止（A ⇔ B を検出した場合、B ⇔ A は検出しない）
- 非重複数の計算ロジックを改善し、正確な統計を表示

#### セキュリティ強化
- `mklink`コマンド実行時に`shell=False`を使用（OSコマンドインジェクション対策）
- コマンドを文字列からリスト形式に変更し、安全性を向上

#### 文字エンコーディング
- ショートカット作成時にUTF-8 BOM付きエンコーディングを使用
- 絵文字や日本語を含むファイル名の文字化けを解消

#### コード品質
- デバッグ用ログを削除し、クリーンアップ
- 冗長な関数を削除・簡略化
- 未使用パラメータを削除
- 不要なファイルとディレクトリを整理

### 技術的変更

#### アーキテクチャ
- `HistoryEntry`クラスを新規作成（履歴・Undo/Redo機能を実装）
- Treeviewを3列から4列に拡張（選択列を追加）
- 選択状態管理機能を実装（`tree_selection_state`辞書）

#### リンク処理
- `create_link`関数に`use_relative_path`パラメータを追加
- `keep_side`パラメータによる動的な処理切り替えを実装
- ショートカット作成時に`WorkingDirectory`プロパティを正しく設定
- リンク検出ロジックを改善（シンボリックリンク/ジャンクション/ハードリンクを正確に区別）

#### その他
- PowerShellスクリプト実行時のエンコーディングをUTF-8 BOMに統一
- アイコンファイル名を`duplicate_link_tool.ico`に統一
- ウィンドウ初期化時の`update_idletasks()`を複数回実行してレイアウトを安定化

---

## v1.0.0 (2025-11-20)

基本的な重複ファイル検出とリンク化機能を提供
- 2つのディレクトリ間での重複ファイル検出
- シンボリックリンク、ハードリンク、ジャンクション、ショートカットの作成
- リンクの実体化機能
- 実体化して圧縮機能
- ダークテーマUI