# Duplicate Link Tool

![Duplicate Link Tool Screenshot](sample/v2.2.0.png)

Duplicate Link Tool は、2 つのフォルダを比較して重複ファイルを見つけ、重複側をショートカットやリンクに置き換えることでディスク容量を節約できる Windows 向けツールです。GUI での操作に対応し、高速かつ正確な重複ファイル検出が特徴で、以下のステップで判定を行います。

1. **ファイル名とサイズが同一** … その時点で同一ファイルとみなします。
2. **それ以外でサイズが一致した組み合わせ** … サイズが同一のファイル同士のSHA-256によるハッシュ比較を実施し、完全一致した場合に重複と判定します。

このハイブリッド方式により、不要なハッシュ計算を避けつつ精度を保てるため、大量のファイルでも軽快に処理できます。

## 主な機能

### 重複検出と処理
- **高速な重複検出**: ファイル名・サイズによる一次判定と、必要時のみSHA-256ハッシュを計算する効率的なアルゴリズム
- **リンクファイルの除外**: ショートカット、シンボリックリンク、ハードリンクを重複検出から除外し、誤検出を防止
- **同一フォルダ比較の最適化**: 「αと同じ」チェックボックスで同じフォルダ内の重複を高速検出
- **検出結果の選択機能**: チェックボックスで処理したいファイルを個別選択（Shift+クリックで範囲選択も可能）
- **重複検出結果を一覧表示**: 確認しながら処理を進められます
- **サイズ列表示**: リンク化で削減されるサイズを一覧に表示
- **ヘッダークリックによるソート**: サイズ（降順/昇順切替）、判定内容（理由別切替）、フォルダ名（グループ化）でソート可能
- **選択情報のリアルタイム表示**: 選択したアイテム数と合計サイズを表示

### リンク作成機能
- **3種類のリンク形式に対応**: ショートカット／シンボリックリンク／ハードリンク
  - ⚠️ **シンボリックリンクの注意**: ファイル構造の変更やドライブ間移動/コピーでリンク切れまたは処理がハングします（相対/絶対パス共通）
  - ⚠️ **ハードリンクの注意**: ドライブ間で移動するとリンクが解除され、各ファイルが独立した実体になります（容量削減効果が失われる）
- **相対パス・絶対パスの選択**（シンボリックリンクのみ）:
  - **相対パス**: フォルダ構造ごと移動する場合に有効（リンク単体の移動では壊れる）
  - **絶対パス**: リンクファイルだけを移動する場合に有効（フォルダ構造の移動では壊れる）
  - ※ショートカットは内部的に常に絶対パスを保存するため、この設定は無効化されます
- **どちらを残すか選択可能**: α側・β側のどちらを実体として残すかを柔軟に選択
- **リンク状況の詳細表示**: ショートカット、シンボリックリンク、ハードリンクを個別にカウント・表示
- **双方向リンク防止機能**: 両方のファイルがすでにリンクの場合、処理をスキップしてデータ消失を防止

### その他機能
- **パス入力履歴**: 上下矢印キーで過去に入力したパスを再利用（最大50件、セッション中保持）
- **Undo/Redo機能**: パス入力欄でCtrl+Z（元に戻す）とCtrl+Y（やり直し）が使用可能
- **非重複ファイルの確認**: 重複側のフォルダから、非重複ファイルをエクスプローラーで一覧表示可能
- **リンクの実体化とZIP化**: リンクを実体化して ZIP にまとめる補助機能を搭載
- **CSV出力とログ記録**: 比較結果を `duplicate_report.csv` に出力し、操作ログを記録

## 使い方

1. **フォルダの指定**
   - αディレクトリ（比較対象の任意フォルダ）とβディレクトリ（比較対象の任意フォルダ）を選択します
   - 同じフォルダ内で重複検出したい場合は「αと同じ」チェックボックスをオンにします
   - パス入力欄では履歴機能（↑↓キー）とUndo/Redo（Ctrl+Z/Y）が使用できます

2. **重複の検出**
   - 「●● 重複を検出」ボタンでスキャンを実行すると、重複一覧が表示されます
   - 検出結果リストの左側にあるチェックボックスで、処理したいファイルを選択できます
   - ヘッダーのチェックボックスで全選択/全解除、Shift+クリックで範囲選択が可能です

3. **リンク化の実行**
   - リンク種別（ショートカット／シンボリックリンク／ハードリンク）を選択
   - パス形式（相対パス／絶対パス）を選択（デフォルト：相対パス）
   - どちらを残すか（αを残す／βを残す）を選択（デフォルト：αを残す）
   - 「リンク化を実行」で選択したファイルをリンクに置き換え（元ファイルは削除されます）

4. **その他機能**
   - 非重複ファイルの確認：重複していないファイルをエクスプローラーで開きます
   - リンクの実体化：リンクを実体ファイルに戻します
   - ZIP化：実体化したファイルをZIPにまとめます

> **注意:** ショートカットやリンク作成には管理者権限が必要です。起動時に昇格ダイアログが表示されます。

## 動作環境

- Windows 10 以降（管理者権限が必要）
- NTFSファイルシステム（シンボリックリンク・ハードリンクに必須）
- Python 3.9 以上（ソースから実行する場合）
- PowerShell（ショートカット操作やリンク実体化に使用）

## リンク形式の比較と制限事項

各リンク形式にはWindowsの仕様による制限があります。用途に応じて適切な形式を選択してください。

### リンク形式の比較表

| 項目 | ショートカット (.lnk) | シンボリックリンク | ハードリンク |
|-----|---------------------|------------------|-------------|
| ドライブ間で作成 | ✅ 可能 | ✅ 可能 | ❌ 不可 |
| フォルダに対応 | ✅ 可能 | ✅ 可能 | ❌ ファイルのみ |
| ドライブ間移動/コピー | ✅ 動作 | ❌ 処理がハング | ❌ リンク解除 |
| ファイル構造変更への耐性 | ✅ 自動追従 | ❌ リンク切れ | ✅ 影響なし |
| 管理者権限 | 不要 | **必要** | **必要** |
| ネットワークドライブ | ✅ 可能 | ❌ ローカルのみ | ❌ ローカルのみ |
| ファイルシステム | FAT32/exFAT/NTFS | NTFSのみ | NTFSのみ |
| 容量削減効果 | △ 小さい（数KB消費） | ◎ 高い | ◎ 高い |
| 他アプリからの認識 | `.lnk`ファイルとして認識 | 透過的（通常ファイルと同様） | 透過的（通常ファイルと同様） |

### 制限事項の詳細

#### シンボリックリンク
- **管理者権限が必要**: 作成には管理者権限が必要です（本ツールは自動で昇格）
- **ネットワークドライブ非対応**: ローカルドライブ間でのみ作成可能
- **ドライブ間移動/コピー不可**: 相対パス・絶対パスに関係なく、ドライブをまたいだ移動/コピーで処理がハングします
- **ファイル構造変更に脆弱**: リンクファイルまたは実体ファイルの場所を変更するとリンク切れになります（同一ドライブ内でも）

#### ハードリンク
- **同一ボリューム限定**: 異なるドライブ/パーティション間では作成不可
- **ファイルのみ**: フォルダには作成できません
- **最大リンク数**: 1ファイルあたり最大1023個
- **ドライブ間移動でリンク解除**: 別ドライブに移動すると独立したファイルになります

#### ショートカット
- **別ファイルとして扱われる**: エクスプローラー以外のアプリケーションは `.lnk` ファイルとして認識します
- **ファイルサイズ**: リンクファイル自体が数KB程度の容量を消費します

### 運用上の注意点

| 項目 | 影響 |
|-----|------|
| **OneDrive/クラウド同期** | シンボリックリンク・ハードリンクは正常に同期されない可能性があります |
| **バックアップソフト** | リンクの扱いはソフトによって異なります（実体としてコピー or リンクとしてコピー） |
| **ウイルス対策ソフト** | シンボリックリンクを不審なファイルとして検出する場合があります |
| **ZIP圧縮** | リンクは通常、実体としてアーカイブされます（リンク関係は失われます） |
| **パス長制限** | Windowsのデフォルトは260文字まで（長いパスを有効化していない場合） |

### 推奨される使い分け

- **同一ドライブ内で運用、ファイル構造を変更しない**: シンボリックリンク（透過的アクセス）またはハードリンク（最大の容量削減）
- **同一ドライブ内で運用、ファイル構造を変更する可能性あり**: ハードリンク（構造変更に影響されない）
- **ドライブ間で移動する可能性あり**: ショートカット（唯一ドライブ間移動と構造変更に対応）

## 重複判定のアルゴリズム

前述の 2 段階判定を迅速に行うため、メイン側フォルダのメタデータを事前にインデックス化し、比較側はスレッドプールで並列処理します。サイズが一致した候補については、必要になった場合にのみ SHA-256 を計算することで無駄なハッシュ処理を最小限に抑えています。

## インストールと実行

### 1. リリース版

1. GitHub リリースページから最新の `DuplicateLinkTool.exe` をダウンロードします。
2. ファイルを右クリックし、「管理者として実行」を選択します。
3. 起動後は GUI の指示に従い、メインフォルダ（残す側）と比較フォルダ（リンク化する側）を選択してください。

> **注意:** リポジトリにはビルド済みの EXE は含まれていません。最新リリースをご利用ください。

### 2. ソースコードから実行

1. 任意のディレクトリでリポジトリをクローンします。
2. （任意）仮想環境を作成してアクティベートします。
3. 追加の外部パッケージは不要です。以下のコマンドで起動できます。

```powershell
python duplicate_link_tool_windows.py
```

管理者権限での再起動を避けたい場合は、実行前に環境変数 `DLTOOL_SKIP_ELEVATION=1` を設定してください。

```powershell
set DLTOOL_SKIP_ELEVATION=1
python duplicate_link_tool_windows.py
```

## バージョン情報

現在のバージョン: **v2.2.0 (2026-02-20)**

詳細な変更点については [PATCH_NOTES.md](PATCH_NOTES.md) をご覧ください。

### v2.2.0の主な変更
- **高DPIディスプレイ対応**: System DPI Awareによりネイティブ解像度で鮮明にUI描画（4K等の高解像度環境で改善）
- **リンク化チェーン衝突の自動解決**: A=B=Cの重複で同時リンク化時にターゲットを最終実体に自動リダイレクト
- **Treeview / ログ間のドラッグリサイズ**: 分割バーをドラッグしてTreeviewとログ領域のサイズを調整可能に
- **ウィンドウリサイズ追従**: ウィンドウ縮小・拡大時にログ領域の高さを自動調整
- **同一ファイル検出の強化**: `os.path.samefile()`による物理ファイル比較でジャンクション・subst等経由の同一ファイルを確実に除外
- **非ANSI文字パスのショートカット対応**: 絵文字等cp932範囲外の文字を含むパスで8.3短縮パスを自動使用
- **リンク作成の安全性向上**: リンク作成成功後にのみ元ファイルを削除し、データ消失リスクを排除
- **型アノテーション現代化**: `typing` モジュール依存を除去し PEP 604 形式に全面移行
- **アプリケーションマニフェスト導入**: 管理者権限要求・DPI宣言・Common Controls v6.0 を外部マニフェストに統合

### v2.1.0の主な変更
- **サイズ列の追加**: 重複一覧にリンク化で削減されるサイズを表示
- **ヘッダークリックソート**: サイズ（降順/昇順）、判定内容（理由別）、フォルダ名（グループ化）
- **選択情報表示**: 選択アイテム数と合計サイズをリアルタイム表示
- **PowerShellパス検出の堅牢化**: powershell_not_foundエラーの修正
- **サイズ表示の統一**: 重複合計サイズ・各行のサイズ・選択時の合計サイズをα側に統一
- **長いパスのショートカット作成対応**: 日本語パス等でANSIバイト数がMAX_PATHを超える場合も一時ファイル方式で確実に作成
- **PowerShellエンコーディング修正**: 日本語環境でのサブプロセス出力エラーを修正
- **リンク化処理の例外安全性改善**: 例外発生時もUIが正常に復元されるように改善

### v2.0.0の主な変更
- **ジャンクション機能の削除**: ファイル単位の重複検出とリンク化に特化するため、ジャンクション作成機能を削除
- **リンクファイルの除外**: 重複検出時にショートカット、シンボリックリンク、ハードリンクを除外
- **双方向リンク防止**: 両方のファイルがリンクの場合、処理をスキップしてデータ消失を防止
- **カラーコーディングUI**: 色付き●でディレクトリとボタンの関連性を視覚化
- **ボタンの視覚的フィードバック**: クリック時に押下状態を表示
- **設定の動的無効化**: ハードリンク選択時に無関係な設定をグレーアウト
- **非重複ファイル表示のキャンセル機能**: 処理中でもキャンセルボタンで中断可能
- **コードリファクタリング**: Appクラスの構造化により可読性・保守性を向上

## 使い方の流れ

1. αディレクトリとβディレクトリを指定します（同一フォルダ比較の場合は「αと同じ」をチェック）。
2. 「●● 重複を検出」を実行すると、重複ファイルが一覧に表示されます。
3. 検出結果リストでチェックボックスを使い、処理したいファイルを選択します。
4. リンク種別（ショートカット／シンボリックリンク／ハードリンク）、パス形式（相対／絶対）、残す側（α／β）を選択します。
5. 「リンク化を実行」で選択したファイルをリンクに置き換えます（元ファイルは削除されます）。
6. 必要に応じて、非重複ファイルの確認やリンクの実体化・ZIP化を行ってください。

## 出力とログ

- `duplicate_report.csv`: 検出した重複の一覧（メイン側、比較側、判定理由、サイズ）
- `link_tool_log_*.txt`: 操作ログ（重複検出・リンク化処理などの実行記録）

## EXE のビルド方法

プロジェクトに同梱されている PyInstaller 設定ファイル `DuplicateLinkTool.spec` を使用します。

1. PyInstaller をインストールします。

```powershell
pip install pyinstaller
```

2. プロジェクトのルートで以下を実行します。

```powershell
pyinstaller DuplicateLinkTool.spec
```

3. `dist/DuplicateLinkTool.exe` が生成されます。必要に応じて `version_info.txt` や `assets/duplicate_link_tool.ico` を調整してください。

## その他

- `zip_util.py`: リンクの実体化および ZIP 化に関連するユーティリティ群をまとめています。

## トラブルシューティング

- **管理者ダイアログが表示され続ける**: PowerShell の実行ポリシーや UAC 設定を確認してください。開発用途で権限昇格を無効にする場合は `DLTOOL_SKIP_ELEVATION=1` を設定します。
- **ショートカットの作成に失敗する**: PowerShell または Windows Script Host が無効化されていないか確認してください。
- **日本語パスでショートカット作成時にエラーが出る**: v2.1.0で対応済みです。日本語文字はANSIエンコーディング（cp932）で2バイト消費するため、パスが長い場合に一時ファイル方式で自動的に回避します。
- **リンク先の実体化でエラーが出る**: リンク先が既に削除されている場合があります。ログに詳細が出力されます。
- **シンボリックリンクをドライブ間で移動/コピーすると処理が進まない**: シンボリックリンクは相対パス・絶対パスに関係なく、ドライブをまたいだ操作で処理がハングします（Windowsのファイルシステム仕様による制限）。
ドライブ間で移動する可能性がある場合は「ショートカット」を使用してください。
- **ハードリンクをドライブ間で移動するとリンクが解除される**: ハードリンクは同一ドライブ内でのみ有効なため、別ドライブに移動すると各ファイルが独立した実体になります（容量削減効果が失われます）。

## 免責事項

本ツールは重複ファイルの削除やリンク化を自動で行います。重要データでの使用に先立ち、十分なバックアップを取得してください。利用に伴う損害について開発者は責任を負いません。
